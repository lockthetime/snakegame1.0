<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯çˆ±è´ªåƒè›‡æ¸¸æˆ ğŸ</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½®å’ŒåŸºç¡€è®¾ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 95vw;
            height: 95vh;
            max-width: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        /* å·¦ä¾§æ¸¸æˆåŒºåŸŸ */
        .game-area-left {
            flex: 2;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* å³ä¾§æ§åˆ¶åŒºåŸŸ */
        .controls-area-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 280px;
            max-width: 350px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        .title {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        /* åˆ†æ•°æ˜¾ç¤º */
        .score-board {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 10px;
        }

        .score-item {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            flex: 1;
            box-shadow: 0 4px 15px rgba(238, 90, 36, 0.3);
        }

        .score-label {
            display: block;
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .score-value {
            display: block;
            font-size: 1.2em;
            font-weight: 700;
        }

        /* é€Ÿåº¦æ§åˆ¶ */
        .speed-control {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .speed-label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .speed-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .speed-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .speed-mark {
            font-size: 0.8em;
            color: #666;
            font-weight: 500;
        }

        .speed-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 10px;
            border-radius: 10px;
            font-weight: 700;
            min-width: 35px;
            font-size: 0.9em;
        }

        /* æ¸¸æˆæŒ‰é’® */
        .game-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .game-btn {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            border: none;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .start-btn {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
        }

        .pause-btn {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .reset-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .mute-btn {
            background: linear-gradient(135deg, #ffa726, #ff7043);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 167, 38, 0.3);
        }

        .sound-btn {
            background: linear-gradient(135deg, #26c6da, #00acc1);
            color: white;
            box-shadow: 0 4px 15px rgba(38, 198, 218, 0.3);
        }

        .bgm-btn {
            background: linear-gradient(135deg, #ab47bc, #8e24aa);
            color: white;
            box-shadow: 0 4px 15px rgba(171, 71, 188, 0.3);
        }

        /* éŸ³é¢‘æ§åˆ¶é¢æ¿ */
        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .audio-control-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 10px;
            width: 100%;
        }

        .audio-control-item .speed-label {
            font-size: 0.8em;
            margin-bottom: 6px;
        }

        .audio-control-item .speed-slider-container {
            gap: 8px;
        }

        .audio-control-item .speed-mark {
            font-size: 0.7em;
        }

        .audio-control-item .speed-display {
            padding: 4px 8px;
            font-size: 0.8em;
            min-width: 30px;
        }

        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .game-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* æ¸¸æˆç”»å¸ƒ */
        .canvas-container {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }

        #gameCanvas {
            border: 3px solid #333;
            border-radius: 16px;
            background: #f0f8f0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }

        /* æ¸¸æˆç»“æŸè¦†ç›–å±‚ */
        .game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
        }

        .game-over-modal {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-over-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 15px;
        }

        .final-score {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .new-record {
            color: #56ab2f;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 20px;
            display: none;
        }

        /* æ–°çºªå½•å¥–åŠ±å¼¹çª— */
        .reward-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .reward-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            position: relative;
            overflow: hidden;
        }

        .reward-modal::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .reward-title {
            font-size: 2em;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .reward-message {
            font-size: 1.2em;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .developer-contact {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .contact-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .contact-number {
            font-size: 1.3em;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .reward-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reward-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* æ¸¸æˆè¯´æ˜ */
        .instructions {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 12px;
            text-align: left;
        }

        .instructions-title {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .instruction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            background: white;
            border-radius: 6px;
        }

        .instruction-key {
            background: #333;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
        }

        .instruction-emoji {
            font-size: 1em;
        }

        .instruction-text {
            font-size: 0.8em;
            color: #666;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .controls-area-right {
                min-width: auto;
                max-width: none;
            }
            
            .audio-controls {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .audio-control-item {
                flex: 1;
                min-width: 150px;
            }
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
                width: 98vw;
                height: 98vh;
            }
            
            .title {
                font-size: 1.5em;
            }
            
            .game-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .game-btn {
                width: 100%;
            }
            
            .instruction-grid {
                grid-template-columns: 1fr;
            }
            
            #gameCanvas {
                max-width: 100%;
                max-height: 60vh;
            }
        }

        @media (max-width: 480px) {
            .score-board {
                gap: 8px;
            }
            
            .score-item {
                padding: 6px 10px;
            }
            
            .audio-controls {
                flex-direction: column;
            }
            
            .audio-control-item {
                flex: none;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- æ¸¸æˆæ ‡é¢˜ -->
        <div style="text-align: center; margin-bottom: 15px;">
            <h1 class="title">ğŸ å¯çˆ±è´ªåƒè›‡ ğŸ</h1>
            <p class="subtitle">äº«å—ç»å…¸æ¸¸æˆçš„ä¹è¶£å§ï¼</p>
        </div>

        <!-- åˆ†æ•°æ˜¾ç¤º -->
        <div class="score-board">
            <div class="score-item">
                <span class="score-label">å½“å‰åˆ†æ•°</span>
                <span class="score-value" id="currentScore">0</span>
            </div>
            <div class="score-item">
                <span class="score-label">æœ€é«˜åˆ†</span>
                <span class="score-value" id="highScore">0</span>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§æ¸¸æˆåŒºåŸŸ -->
            <div class="game-area-left">
                <!-- æ¸¸æˆç”»å¸ƒ -->
                <div class="canvas-container">
                    <canvas id="gameCanvas" width="800" height="600"></canvas>
                    
                    <!-- æ¸¸æˆç»“æŸè¦†ç›–å±‚ -->
                    <div class="game-over-overlay" id="gameOverOverlay">
                        <div class="game-over-modal">
                            <h2 class="game-over-title">ğŸ˜µ æ¸¸æˆç»“æŸï¼</h2>
                            <div class="final-score">
                                ä½ çš„åˆ†æ•°ï¼š<span id="finalScore">0</span>
                            </div>
                            <div class="new-record" id="newRecord">ğŸ‰ æ­å–œï¼æ–°çºªå½•ï¼</div>
                            <button id="restartBtn" class="game-btn start-btn">
                                <span>ğŸ®</span>
                                å†æ¥ä¸€å±€
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ§åˆ¶åŒºåŸŸ -->
            <div class="controls-area-right">
                <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
                <div class="game-controls">
                    <button id="startBtn" class="game-btn start-btn">
                        <span>ğŸ®</span>
                        å¼€å§‹æ¸¸æˆ
                    </button>
                    <button id="pauseBtn" class="game-btn pause-btn" disabled>
                        <span>â¸ï¸</span>
                        æš‚åœ
                    </button>
                    <button id="resetBtn" class="game-btn reset-btn">
                        <span>ğŸ”„</span>
                        é‡æ–°å¼€å§‹
                    </button>
                </div>

                <!-- é€Ÿåº¦æ§åˆ¶ -->
                <div class="speed-control">
                    <label for="speedSlider" class="speed-label">ğŸš€ æ¸¸æˆé€Ÿåº¦è®¾ç½®</label>
                    <div class="speed-slider-container">
                        <span class="speed-mark">æ…¢</span>
                        <input type="range" id="speedSlider" min="1" max="10" value="5" class="speed-slider">
                        <span class="speed-mark">å¿«</span>
                        <span class="speed-display" id="speedValue">5</span>
                    </div>
                </div>

                <!-- éŸ³é¢‘æ§åˆ¶ -->
                <div class="audio-controls">
                    <button id="soundToggle" class="game-btn sound-btn">
                        <span id="soundIcon">ğŸ”Š</span>
                        <span id="soundText">éŸ³æ•ˆ: å¼€å¯</span>
                    </button>
                    <button id="bgmToggle" class="game-btn bgm-btn">
                        <span id="bgmIcon">ğŸµ</span>
                        <span id="bgmText">éŸ³ä¹: å¼€å¯</span>
                    </button>
                    <button id="muteAllBtn" class="game-btn mute-btn">
                        <span id="muteIcon">ğŸ”Š</span>
                        <span id="muteText">å…¨å±€é™éŸ³</span>
                    </button>
                </div>

                <!-- æ¸¸æˆè¯´æ˜ -->
                <div class="instructions">
                    <h3 class="instructions-title">ğŸ¯ æ¸¸æˆè¯´æ˜</h3>
                    <div class="instruction-grid">
                        <div class="instruction-item">
                            <span class="instruction-key">â†‘ â†“ â† â†’</span>
                            <span class="instruction-text">æ§åˆ¶æ–¹å‘</span>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-key">ç©ºæ ¼</span>
                            <span class="instruction-text">æš‚åœ/ç»§ç»­</span>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-emoji">ğŸ</span>
                            <span class="instruction-text">åƒè‹¹æœå¾—åˆ†</span>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-emoji">ğŸ’¥</span>
                            <span class="instruction-text">é¿å…ç¢°æ’</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°çºªå½•å¥–åŠ±å¼¹çª— -->
    <div class="reward-overlay" id="rewardOverlay">
        <div class="reward-modal">
            <h2 class="reward-title">ğŸ‰ æ­å–œï¼ğŸ‰</h2>
            <div class="reward-message">
                å“‡ï¼Œä½ å±…ç„¶åˆ›é€ äº†æ–°è®°å½•ï¼<br>
                å¥–åŠ±ä½ å¼€å‘è€…è”ç³»æ–¹å¼ï¼š
            </div>
            <div class="developer-contact">
                <div class="contact-label">å¼€å‘è€…å¾®ä¿¡/ç”µè¯</div>
                <div class="contact-number">19121393207</div>
            </div>
            <button class="reward-close-btn" id="rewardCloseBtn">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
    
    <script>
        // æ¸¸æˆå˜é‡
        let canvas, ctx;
        let snake = [{x: 400, y: 300}];  // è›‡çš„åˆå§‹ä½ç½®ï¼ˆç”»å¸ƒä¸­å¿ƒï¼‰
        let direction = {x: 0, y: 0};    // ç§»åŠ¨æ–¹å‘
        let food = {};                    // é£Ÿç‰©ä½ç½®
        let score = 0;                    // å½“å‰åˆ†æ•°
        let highScore = 0;                // æœ€é«˜åˆ†
        let gameRunning = false;          // æ¸¸æˆçŠ¶æ€
        let gameLoop;                     // æ¸¸æˆå¾ªç¯
        let gameSpeed = 5;                // æ¸¸æˆé€Ÿåº¦

        // ç½‘æ ¼å¤§å°
        const GRID_SIZE = 20;

        // éŸ³æ•ˆç³»ç»Ÿ
        let audioContext;
        let soundEnabled = true;
        let bgmEnabled = true;
        let globalMuted = false;
        let bgmOscillator = null;
        let bgmGainNode = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
            setupEventListeners();
            loadHighScore();
            initAudio();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // ç”Ÿæˆéšæœºé£Ÿç‰©ä½ç½®
            generateFood();
            
            // ç»˜åˆ¶åˆå§‹æ¸¸æˆçŠ¶æ€
            drawGame();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å¼€å§‹æŒ‰é’®
            document.getElementById('startBtn').addEventListener('click', startGame);
            
            // æš‚åœæŒ‰é’®
            document.getElementById('pauseBtn').addEventListener('click', pauseGame);
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtn').addEventListener('click', resetGame);
            
            // é‡æ–°å¼€å§‹æŒ‰é’®
            document.getElementById('restartBtn').addEventListener('click', restartGame);
            
            // é€Ÿåº¦æ»‘å—
            const speedSlider = document.getElementById('speedSlider');
            speedSlider.addEventListener('input', function() {
                gameSpeed = parseInt(this.value);
                document.getElementById('speedValue').textContent = gameSpeed;
                
                // å¦‚æœæ¸¸æˆæ­£åœ¨è¿è¡Œï¼Œæ›´æ–°æ¸¸æˆå¾ªç¯é€Ÿåº¦
                if (gameRunning) {
                    clearInterval(gameLoop);
                    startGameLoop();
                }
            });

            // éŸ³æ•ˆå¼€å…³
            const soundToggle = document.getElementById('soundToggle');
            soundToggle.addEventListener('click', function() {
                soundEnabled = !soundEnabled;
                document.getElementById('soundIcon').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                document.getElementById('soundText').textContent = soundEnabled ? 'éŸ³æ•ˆ: å¼€å¯' : 'éŸ³æ•ˆ: å…³é—­';
            });

            // èƒŒæ™¯éŸ³ä¹å¼€å…³
            const bgmToggle = document.getElementById('bgmToggle');
            bgmToggle.addEventListener('click', function() {
                bgmEnabled = !bgmEnabled;
                document.getElementById('bgmIcon').textContent = bgmEnabled ? 'ğŸµ' : 'ğŸµ';
                document.getElementById('bgmText').textContent = bgmEnabled ? 'éŸ³ä¹: å¼€å¯' : 'éŸ³ä¹: å…³é—­';
                
                if (bgmEnabled && !globalMuted) {
                    startBackgroundMusic();
                } else {
                    stopBackgroundMusic();
                }
            });

            // å…¨å±€é™éŸ³æŒ‰é’®
            const muteAllBtn = document.getElementById('muteAllBtn');
            muteAllBtn.addEventListener('click', function() {
                globalMuted = !globalMuted;
                
                if (globalMuted) {
                    stopBackgroundMusic();
                    document.getElementById('muteIcon').textContent = 'ğŸ”‡';
                    document.getElementById('muteText').textContent = 'å–æ¶ˆé™éŸ³';
                } else {
                    if (bgmEnabled) {
                        startBackgroundMusic();
                    }
                    document.getElementById('muteIcon').textContent = 'ğŸ”Š';
                    document.getElementById('muteText').textContent = 'å…¨å±€é™éŸ³';
                }
            });

            // å¥–åŠ±å¼¹çª—å…³é—­æŒ‰é’®
            const rewardCloseBtn = document.getElementById('rewardCloseBtn');
            rewardCloseBtn.addEventListener('click', function() {
                document.getElementById('rewardOverlay').style.display = 'none';
            });
            
            // é”®ç›˜æ§åˆ¶
            document.addEventListener('keydown', handleKeyPress);
        }

        // å¤„ç†é”®ç›˜æŒ‰é”®
        function handleKeyPress(event) {
            // é˜»æ­¢æ–¹å‘é”®å’Œç©ºæ ¼é”®çš„é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' ', 'Space'].includes(event.key)) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (!gameRunning && event.key !== ' ' && event.key !== 'Space') return;
            
            switch(event.key) {
                case 'ArrowUp':
                    if (direction.y === 0) {
                        direction = {x: 0, y: -GRID_SIZE};
                        playMoveSound();
                    }
                    break;
                case 'ArrowDown':
                    if (direction.y === 0) {
                        direction = {x: 0, y: GRID_SIZE};
                        playMoveSound();
                    }
                    break;
                case 'ArrowLeft':
                    if (direction.x === 0) {
                        direction = {x: -GRID_SIZE, y: 0};
                        playMoveSound();
                    }
                    break;
                case 'ArrowRight':
                    if (direction.x === 0) {
                        direction = {x: GRID_SIZE, y: 0};
                        playMoveSound();
                    }
                    break;
                case ' ':
                case 'Space':
                    if (gameRunning) {
                        pauseGame();
                    } else {
                        startGame();
                    }
                    break;
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (!gameRunning) {
                gameRunning = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                
                // æ’­æ”¾å¼€å§‹éŸ³æ•ˆ
                playStartSound();
                
                // å¯åŠ¨èƒŒæ™¯éŸ³ä¹
                if (bgmEnabled && !globalMuted) {
                    startBackgroundMusic();
                }
                
                // å¦‚æœè›‡è¿˜æ²¡æœ‰ç§»åŠ¨æ–¹å‘ï¼Œè®¾ç½®é»˜è®¤å‘å³
                if (direction.x === 0 && direction.y === 0) {
                    direction = {x: GRID_SIZE, y: 0};
                }
                
                startGameLoop();
            }
        }

        // æš‚åœæ¸¸æˆ
        function pauseGame() {
            gameRunning = false;
            clearInterval(gameLoop);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            
            // æ’­æ”¾æš‚åœéŸ³æ•ˆ
            playPauseSound();
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            pauseGame();
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            snake = [{x: 400, y: 300}];
            direction = {x: 0, y: 0};
            score = 0;
            
            // æ›´æ–°UI
            document.getElementById('currentScore').textContent = score;
            
            // éšè—æ¸¸æˆç»“æŸç”»é¢
            document.getElementById('gameOverOverlay').style.display = 'none';
            
            // ç”Ÿæˆæ–°é£Ÿç‰©
            generateFood();
            drawGame();
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            resetGame();
            startGame();
        }

        // å¼€å§‹æ¸¸æˆå¾ªç¯
        function startGameLoop() {
            // æ ¹æ®é€Ÿåº¦è®¡ç®—å»¶è¿Ÿæ—¶é—´ï¼ˆé€Ÿåº¦è¶Šé«˜ï¼Œå»¶è¿Ÿè¶ŠçŸ­ï¼‰
            const delay = 200 - (gameSpeed - 1) * 15; // é€Ÿåº¦1: 185ms, é€Ÿåº¦10: 65ms
            gameLoop = setInterval(updateGame, delay);
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function updateGame() {
            if (!gameRunning) return;
            
            // ç§»åŠ¨è›‡å¤´
            const head = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};
            
            // æ£€æŸ¥ç¢°æ’
            if (checkCollision(head)) {
                gameOver();
                return;
            }
            
            snake.unshift(head);
            
            // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                document.getElementById('currentScore').textContent = score;
                generateFood();
                
                // æ’­æ”¾åƒé£Ÿç‰©éŸ³æ•ˆ
                playEatSound();
            } else {
                snake.pop();
            }
            
            drawGame();
        }

        // æ£€æŸ¥ç¢°æ’
        function checkCollision(head) {
            // æ£€æŸ¥å¢™å£ç¢°æ’
            if (head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height) {
                return true;
            }
            
            // æ£€æŸ¥è‡ªèº«ç¢°æ’
            for (let segment of snake) {
                if (head.x === segment.x && head.y === segment.y) {
                    return true;
                }
            }
            
            return false;
        }

        // ç”Ÿæˆéšæœºé£Ÿç‰©ä½ç½®
        function generateFood() {
            let validPosition = false;
            
            while (!validPosition) {
                food = {
                    x: Math.floor(Math.random() * (canvas.width / GRID_SIZE)) * GRID_SIZE,
                    y: Math.floor(Math.random() * (canvas.height / GRID_SIZE)) * GRID_SIZE
                };
                
                // ç¡®ä¿é£Ÿç‰©ä¸åœ¨è›‡èº«ä¸Š
                validPosition = true;
                for (let segment of snake) {
                    if (food.x === segment.x && food.y === segment.y) {
                        validPosition = false;
                        break;
                    }
                }
            }
        }

        // ç»˜åˆ¶æ¸¸æˆç”»é¢
        function drawGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#f0f8f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            drawGrid();
            
            // ç»˜åˆ¶è›‡
            drawSnake();
            
            // ç»˜åˆ¶é£Ÿç‰©
            drawFood();
        }

        // ç»˜åˆ¶ç½‘æ ¼çº¿
        function drawGrid() {
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // ç»˜åˆ¶å‚ç›´çº¿
            for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶æ°´å¹³çº¿
            for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // ç»˜åˆ¶è›‡
        function drawSnake() {
            snake.forEach((segment, index) => {
                if (index === 0) {
                    // è›‡å¤´ - æ›´äº®çš„ç»¿è‰²
                    ctx.fillStyle = '#4CAF50';
                } else {
                    // è›‡èº« - è¾ƒæ·±çš„ç»¿è‰²
                    ctx.fillStyle = '#81C784';
                }
                
                // ç»˜åˆ¶åœ†è§’çŸ©å½¢
                drawRoundedRect(segment.x + 1, segment.y + 1, GRID_SIZE - 2, GRID_SIZE - 2, 4);
                
                // å¦‚æœæ˜¯è›‡å¤´ï¼Œç»˜åˆ¶çœ¼ç›
                if (index === 0) {
                    ctx.fillStyle = '#2E7D32';
                    const eyeSize = 3;
                    const eyeOffset = 6;
                    
                    // æ ¹æ®ç§»åŠ¨æ–¹å‘è°ƒæ•´çœ¼ç›ä½ç½®
                    if (direction.x > 0) { // å‘å³
                        ctx.fillRect(segment.x + 12, segment.y + 5, eyeSize, eyeSize);
                        ctx.fillRect(segment.x + 12, segment.y + 12, eyeSize, eyeSize);
                    } else if (direction.x < 0) { // å‘å·¦
                        ctx.fillRect(segment.x + 5, segment.y + 5, eyeSize, eyeSize);
                        ctx.fillRect(segment.x + 5, segment.y + 12, eyeSize, eyeSize);
                    } else if (direction.y > 0) { // å‘ä¸‹
                        ctx.fillRect(segment.x + 5, segment.y + 12, eyeSize, eyeSize);
                        ctx.fillRect(segment.x + 12, segment.y + 12, eyeSize, eyeSize);
                    } else if (direction.y < 0) { // å‘ä¸Š
                        ctx.fillRect(segment.x + 5, segment.y + 5, eyeSize, eyeSize);
                        ctx.fillRect(segment.x + 12, segment.y + 5, eyeSize, eyeSize);
                    } else { // é»˜è®¤çŠ¶æ€
                        ctx.fillRect(segment.x + 6, segment.y + 5, eyeSize, eyeSize);
                        ctx.fillRect(segment.x + 11, segment.y + 5, eyeSize, eyeSize);
                    }
                }
            });
        }

        // ç»˜åˆ¶é£Ÿç‰©ï¼ˆè‹¹æœæ ·å¼ï¼‰
        function drawFood() {
            // è‹¹æœä¸»ä½“ - çº¢è‰²
            ctx.fillStyle = '#F44336';
            drawRoundedRect(food.x + 2, food.y + 4, GRID_SIZE - 4, GRID_SIZE - 6, 6);
            
            // è‹¹æœèŒ - æ£•è‰²
            ctx.fillStyle = '#8D6E63';
            ctx.fillRect(food.x + 9, food.y + 1, 2, 4);
            
            // è‹¹æœå¶å­ - ç»¿è‰²
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(food.x + 11, food.y + 1, 4, 2);
            
            // è‹¹æœé«˜å…‰
            ctx.fillStyle = '#FFCDD2';
            ctx.fillRect(food.x + 5, food.y + 6, 3, 3);
        }

        // ç»˜åˆ¶åœ†è§’çŸ©å½¢
        function drawRoundedRect(x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            clearInterval(gameLoop);
            
            // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
            playGameOverSound();
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (score > highScore) {
                highScore = score;
                document.getElementById('highScore').textContent = highScore;
                document.getElementById('newRecord').style.display = 'block';
                saveHighScore();
                
                // æ’­æ”¾æ–°çºªå½•éŸ³æ•ˆ
                setTimeout(() => playNewRecordSound(), 500);
                
                // æ˜¾ç¤ºå¥–åŠ±å¼¹çª—ï¼ˆå»¶è¿Ÿ1.5ç§’åæ˜¾ç¤ºï¼‰
                setTimeout(() => {
                    document.getElementById('rewardOverlay').style.display = 'flex';
                }, 1500);
            } else {
                document.getElementById('newRecord').style.display = 'none';
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸç”»é¢
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOverOverlay').style.display = 'flex';
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        // ä¿å­˜æœ€é«˜åˆ†åˆ°æœ¬åœ°å­˜å‚¨
        function saveHighScore() {
            localStorage.setItem('snakeHighScore', highScore);
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœ€é«˜åˆ†
        function loadHighScore() {
            const saved = localStorage.getItem('snakeHighScore');
            if (saved) {
                highScore = parseInt(saved);
                document.getElementById('highScore').textContent = highScore;
            }
        }

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio API not supported');
                soundEnabled = false;
            }
        }

        // åˆ›å»ºéŸ³æ•ˆ
        function createBeep(frequency, duration, type = 'sine') {
            if (!soundEnabled || !audioContext || globalMuted) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // å¼€å§‹èƒŒæ™¯éŸ³ä¹ï¼ˆé’¢ç´é£æ ¼ - å¡å†œå®Œæ•´ç‰ˆï¼‰
        function startBackgroundMusic() {
            if (!audioContext || !bgmEnabled || globalMuted) return;
            
            // åœæ­¢ä¹‹å‰çš„èƒŒæ™¯éŸ³ä¹
            stopBackgroundMusic();
            
            // å¡å†œ Canon in D å®Œæ•´æ—‹å¾‹ï¼ˆæ›´ä¼˜ç¾çš„ç‰ˆæœ¬ï¼‰
            const melody = [
                // ç¬¬ä¸€æ®µ
                293.66, 220.00, 246.94, 261.63, 293.66, 220.00, 246.94, 293.66,
                // ç¬¬äºŒæ®µ  
                329.63, 293.66, 329.63, 369.99, 329.63, 293.66, 329.63, 293.66,
                // ç¬¬ä¸‰æ®µ
                369.99, 329.63, 369.99, 392.00, 369.99, 329.63, 293.66, 329.63,
                // ç¬¬å››æ®µ
                293.66, 246.94, 220.00, 246.94, 293.66, 329.63, 369.99, 392.00,
                // ç¬¬äº”æ®µï¼ˆé«˜æ½®ï¼‰
                440.00, 392.00, 440.00, 493.88, 440.00, 392.00, 369.99, 392.00,
                // ç¬¬å…­æ®µ
                369.99, 329.63, 293.66, 329.63, 369.99, 392.00, 440.00, 392.00,
                // ç»“å°¾
                369.99, 329.63, 293.66, 261.63, 293.66, 220.00, 246.94, 293.66
            ];
            
            const noteDurations = [
                // æ›´ä¸°å¯Œçš„èŠ‚æ‹å˜åŒ–
                1.0, 0.5, 0.5, 1.0, 1.0, 0.5, 0.5, 1.5,
                1.0, 0.5, 0.5, 1.0, 1.0, 0.5, 0.5, 1.5,
                1.0, 0.5, 0.5, 1.0, 1.0, 0.5, 0.5, 1.0,
                1.0, 0.5, 0.5, 1.0, 0.75, 0.75, 0.75, 0.75,
                1.5, 0.5, 1.0, 1.0, 1.0, 0.5, 0.5, 1.0,
                1.0, 0.5, 0.5, 1.0, 0.75, 0.75, 0.75, 0.75,
                1.0, 0.5, 0.5, 1.0, 1.0, 0.5, 0.5, 2.0
            ];
            let noteIndex = 0;
            let isPlaying = true;
            
            function playPianoNote(frequency, duration) {
                if (!isPlaying || globalMuted || !bgmEnabled) return;
                
                // åˆ›å»ºé’¢ç´éŸ³è‰²çš„å¤åˆæ³¢å½¢
                const fundamental = audioContext.createOscillator();
                const harmonic2 = audioContext.createOscillator();
                const harmonic3 = audioContext.createOscillator();
                
                const gainNode = audioContext.createGain();
                const gain2 = audioContext.createGain();
                const gain3 = audioContext.createGain();
                const masterGain = audioContext.createGain();
                
                // è®¾ç½®é¢‘ç‡ï¼ˆåŸºé¢‘å’Œè°æ³¢ï¼‰
                fundamental.frequency.value = frequency;
                harmonic2.frequency.value = frequency * 2;
                harmonic3.frequency.value = frequency * 3;
                
                // è®¾ç½®éŸ³è‰²ç±»å‹
                fundamental.type = 'sine';
                harmonic2.type = 'sine';
                harmonic3.type = 'triangle';
                
                // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
                fundamental.connect(gainNode);
                harmonic2.connect(gain2);
                harmonic3.connect(gain3);
                
                gainNode.connect(masterGain);
                gain2.connect(masterGain);
                gain3.connect(masterGain);
                masterGain.connect(audioContext.destination);
                
                // è®¾ç½®éŸ³é‡æ¯”ä¾‹ï¼ˆæ¨¡æ‹Ÿé’¢ç´éŸ³è‰²ï¼‰
                const now = audioContext.currentTime;
                const volume = 0.015; // èƒŒæ™¯éŸ³ä¹éŸ³é‡
                
                gainNode.gain.setValueAtTime(volume, now);
                gain2.gain.setValueAtTime(volume * 0.3, now);
                gain3.gain.setValueAtTime(volume * 0.1, now);
                
                // é’¢ç´åŒ…ç»œï¼ˆADSRï¼‰
                masterGain.gain.setValueAtTime(0, now);
                masterGain.gain.linearRampToValueAtTime(1, now + 0.1); // Attack
                masterGain.gain.exponentialRampToValueAtTime(0.7, now + 0.2); // Decay
                masterGain.gain.setValueAtTime(0.7, now + duration - 0.3); // Sustain
                masterGain.gain.exponentialRampToValueAtTime(0.01, now + duration); // Release
                
                // å¯åŠ¨æŒ¯è¡å™¨
                fundamental.start(now);
                harmonic2.start(now);
                harmonic3.start(now);
                
                // åœæ­¢æŒ¯è¡å™¨
                fundamental.stop(now + duration);
                harmonic2.stop(now + duration);
                harmonic3.stop(now + duration);
            }
            
            function playMelody() {
                if (!isPlaying || globalMuted || !bgmEnabled) return;
                
                const frequency = melody[noteIndex];
                const duration = noteDurations[noteIndex];
                
                playPianoNote(frequency, duration);
                
                noteIndex = (noteIndex + 1) % melody.length;
                
                setTimeout(playMelody, duration * 1000);
            }
            
            // å­˜å‚¨æ’­æ”¾çŠ¶æ€ï¼Œç”¨äºåœæ­¢
            bgmOscillator = { stop: () => { isPlaying = false; } };
            
            playMelody();
        }

        // åœæ­¢èƒŒæ™¯éŸ³ä¹
        function stopBackgroundMusic() {
            if (bgmOscillator) {
                try {
                    bgmOscillator.stop();
                } catch (e) {
                    // å¿½ç•¥å·²ç»åœæ­¢çš„æŒ¯è¡å™¨é”™è¯¯
                }
                bgmOscillator = null;
            }
            if (bgmGainNode) {
                bgmGainNode = null;
            }
        }

        // æ’­æ”¾ç§»åŠ¨éŸ³æ•ˆ
        function playMoveSound() {
            createBeep(200, 0.1, 'square');
        }

        // æ’­æ”¾åƒé£Ÿç‰©éŸ³æ•ˆ
        function playEatSound() {
            createBeep(400, 0.2, 'sine');
            setTimeout(() => createBeep(600, 0.1, 'sine'), 100);
        }

        // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
        function playGameOverSound() {
            createBeep(150, 0.3, 'sawtooth');
            setTimeout(() => createBeep(100, 0.3, 'sawtooth'), 150);
            setTimeout(() => createBeep(75, 0.5, 'sawtooth'), 300);
        }

        // æ’­æ”¾æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
        function playStartSound() {
            createBeep(300, 0.1, 'sine');
            setTimeout(() => createBeep(400, 0.1, 'sine'), 100);
            setTimeout(() => createBeep(500, 0.2, 'sine'), 200);
        }

        // æ’­æ”¾æš‚åœéŸ³æ•ˆ
        function playPauseSound() {
            createBeep(250, 0.2, 'triangle');
        }

        // æ’­æ”¾æ–°çºªå½•éŸ³æ•ˆ
        function playNewRecordSound() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createBeep(400 + i * 100, 0.15, 'sine');
                }, i * 100);
            }
        }
    </script>
</body>
</html>
